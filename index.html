<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>器具員数確認</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:-apple-system}
header{padding:10px 12px;border-bottom:1px solid #333;color:#bbb;font-size:14px}
main{padding:14px;max-width:560px;margin:auto}
.card{border:1px solid #333;border-radius:12px;padding:14px;margin-bottom:12px}
button{width:100%;padding:14px;margin-top:10px;font-size:18px;border-radius:12px;background:#1a1a1a;color:#fff;border:1px solid #333}
.small{font-size:14px;padding:10px}
.toast{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:#000;border:1px solid #333;padding:18px 22px;border-radius:12px;z-index:9999}
.hidden{display:none}
video{width:100%;border-radius:12px;border:1px solid #333}
</style>
</head>
<body>
<header id="hdr"></header>
<main id="app"></main>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbxVpcXoJFFmO_sqOi76kMrD6hgFBR4CdCD5hpI_4bTLD3VeVrP2qbxDiJ_RTrotzLsx/exec";

const p=new URLSearchParams(location.search);
const site=p.get("site")||"";
const tool=p.get("tool")||"";

const app=document.getElementById("app");
const hdr=document.getElementById("hdr");

function toast(msg){
  const d=document.createElement("div");
  d.className="toast";
  d.textContent=msg;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),2000);
}

async function safeFetch(url,opt){
  try{
    const r=await fetch(url,opt);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }catch(e){
    console.error(e);
    toast("通信失敗");
    return null;
  }
}

async function load(){
  hdr.textContent=`現場：${site}　道具：${tool}`;
  app.innerHTML=`<div class="card">状態取得中…</div>`;

  const js=await safeFetch(`${GAS_URL}?mode=status&site=${encodeURIComponent(site)}`);
  if(!js){ app.innerHTML=`<div class="card">取得失敗</div>`; return; }

  const me=js.items.find(x=>x.tool===tool);

  app.innerHTML=`
    <div class="card">
      <b>状態</b><br>
      ${me?me.status:"異常なし"}
    </div>

    <div class="card">
      <button onclick="take()">持ち出し</button>
      <button onclick="ret()">返却（写真必須）</button>
    </div>
  `;
}

async function take(){
  toast("持ち出し送信");
  await safeFetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({site,tool,action:"持ち出し",datetime:new Date().toISOString()})
  });
  load();
}

async function ret(){
  let s;
  try{
    s=await navigator.mediaDevices.getUserMedia({video:true});
  }catch{
    toast("カメラ不可");
    return;
  }
  const v=document.createElement("video");
  v.srcObject=s; v.play();
  setTimeout(async()=>{
    const c=document.createElement("canvas");
    c.width=320; c.height=240;
    c.getContext("2d").drawImage(v,0,0,320,240);
    s.getTracks().forEach(t=>t.stop());

    toast("返却送信");
    await safeFetch(GAS_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        site,tool,action:"返却",
        datetime:new Date().toISOString(),
        photoDataUrl:c.toDataURL("image/jpeg",0.5)
      })
    });
    load();
  },800);
}

load();
</script>
</body>
</html>
