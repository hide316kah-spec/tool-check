<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>tool-check</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#000;
  color:#fff;
}
#hdr{
  padding:14px;
  border-bottom:1px solid #333;
  font-size:14px;
}
.sec{
  padding:14px;
}
.btn{
  width:100%;
  padding:14px;
  margin:8px 0;
  font-size:16px;
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:10px;
}
.list{
  border:1px solid #333;
  border-radius:10px;
  padding:12px;
  margin:10px 0;
}
.small{
  font-size:13px;
  color:#aaa;
}
</style>
</head>

<body>
<div id="hdr"></div>
<div id="app"></div>

<script>
/* ===== 設定 ===== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzgupJn0DPxP6AY-Ocr-Nw3Pt9cSbpRIr3ZMZxYH3R1z9-ydLUhepZwU51WRQB5bLG_Lw/exec";

const TOOL_NAME = {
  T001:"手歯止め",
  T002:"デジタルゲージ",
  T003:"検測用具",
  T004:"誘導棒"
};

/* ===== URL ===== */
const p = new URLSearchParams(location.search);
const site = p.get("site") || "千葉機械ライン";
const tool = p.get("tool");            // ← 無い場合は「確認者画面」
let user  = localStorage.getItem("toolcheck_user") || "";

/* ===== 共通 ===== */
const hdr = document.getElementById("hdr");
const app = document.getElementById("app");

hdr.textContent = `現場：${site}　端末：${user || "未入力"}`;

/* ===== API ===== */
async function getStatus(){
  const r = await fetch(`${GAS_URL}?mode=status&site=${encodeURIComponent(site)}`);
  return r.json();
}
async function post(action, item){
  await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      site,
      tool:item.tool,
      toolName:item.toolName,
      action,
      user,
      datetime:new Date().toISOString()
    })
  });
}

/* ======================================================
   ① タグ読んだ画面（既存動作・触ってない）
====================================================== */
if(tool){
  renderBorrow();
}else{
/* ======================================================
   ② 確認者画面（ここだけ修正）
====================================================== */
  renderApprover();
}

/* ===== 借りる画面 ===== */
async function renderBorrow(){
  const data = await getStatus();
  const item = data.items.find(i=>i.tool===tool) || {
    tool, toolName:TOOL_NAME[tool]||"不明", status:"IN"
  };

  app.innerHTML = `
    <div class="sec">
      <div class="list">
        状態：${ item.status==="OUT" ? "持ち出し中" : "持ち出しなし" }
      </div>
      <button class="btn" onclick="doBorrow()">持ち出し</button>
    </div>
  `;
}

async function doBorrow(){
  if(!user){
    user = prompt("名前を入力");
    if(!user) return;
    localStorage.setItem("toolcheck_user",user);
    hdr.textContent = `現場：${site}　端末：${user}`;
  }
  await post("持ち出し",{ tool, toolName:TOOL_NAME[tool] });
  location.reload();
}

/* ===== 確認者画面 ===== */
async function renderApprover(){
  const data = await getStatus();
  const pending = data.items.filter(i=>i.status==="PENDING");

  let html = `
    <div class="sec">
      <div class="list">
        状態：${ pending.length ? "返却確認待ち" : "持ち出しなし" }
      </div>
  `;

  if(pending.length){
    pending.forEach(i=>{
      html += `
        <div class="list">
          <b>${i.toolName} (${i.tool})</b><br>
          <span class="small">${i.by} / ${new Date(i.at).toLocaleString()}</span>
          <button class="btn" onclick="approve('${i.tool}','${i.toolName}')">確認</button>
        </div>
      `;
    });
  }

  html += "</div>";
  app.innerHTML = html;
}

async function approve(tid,tname){
  if(!user){
    user = prompt("名前を入力");
    if(!user) return;
    localStorage.setItem("toolcheck_user",user);
    hdr.textContent = `現場：${site}　端末：${user}`;
  }
  await post("確認",{ tool:tid, toolName:tname });
  location.reload();
}
</script>
</body>
</html>
