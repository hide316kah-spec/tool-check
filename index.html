<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>器具員数確認</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:-apple-system}
header{padding:10px 12px;border-bottom:1px solid #333;color:#bbb;font-size:14px}
main{padding:14px;max-width:560px;margin:auto}
.card{border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:14px}
h2{margin:0 0 8px;font-size:20px}
button{width:100%;padding:16px;font-size:20px;border-radius:12px;background:#1a1a1a;color:#fff;border:1px solid #333;margin-top:10px}
.stateOut{border-color:#a33}
.statePending{border-color:#aa3}
.stateIn{border-color:#333}
.small{opacity:.7;font-size:14px}
</style>
</head>
<body>
<header id="hdr"></header>
<main id="app"></main>

<script>
/* ===== 設定 ===== */
const GAS_URL =
"https://script.google.com/macros/s/AKfycbxVpcXoJFFmO_sqOi76kMrD6hgFBR4CdCD5hpI_4bTLD3VeVrP2qbxDiJ_RTrotzLsx/exec";

/* ===== URL ===== */
const p=new URLSearchParams(location.search);
const site=p.get("site")||"未指定";
const tool=p.get("tool")||"未指定";

/* ===== DOM ===== */
const hdr=document.getElementById("hdr");
const app=document.getElementById("app");

hdr.textContent=`現場：${site}　道具：${tool}`;

/* ===== POST ===== */
async function post(action){
  await fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      site, tool,
      toolName:tool,
      action,
      user:"現場端末"
    })
  });
}

/* ===== 描画 ===== */
function draw(state,title,sub,buttons){
  app.innerHTML=`
    <div class="card ${state}">
      <h2>${title}</h2>
      <div class="small">${sub||""}</div>
      ${buttons||""}
    </div>
  `;
}

/* ===== 状態取得 ===== */
async function loadStatus(){
  draw("stateIn","状態取得中…","");
  try{
    const r=await fetch(
      GAS_URL+"?mode=status&site="+encodeURIComponent(site)+"&t="+Date.now()
    );
    const j=await r.json();
    const me=j.items.find(x=>x.tool===tool);

    if(!me){
      draw(
        "stateIn",
        "異常なし",
        "持ち出し・返却待ちはありません",
        `<button onclick="take()">持ち出し</button>`
      );
      return;
    }

    if(me.status==="OUT"){
      draw(
        "stateOut",
        "持ち出し中",
        "",
        `<button onclick="ret()">返却</button>`
      );
      return;
    }

    if(me.status==="PENDING"){
      draw(
        "statePending",
        "返却確認待ち",
        "",
        ""
      );
      return;
    }

  }catch(e){
    draw("stateIn","通信失敗","状態を取得できません");
  }
}

/* ===== 操作 ===== */
async function take(){
  await post("持ち出し");
  loadStatus();
}

async function ret(){
  await post("返却");
  loadStatus();
}

/* ===== 起動 ===== */
loadStatus();
setInterval(loadStatus,15000);
</script>
</body>
</html>
