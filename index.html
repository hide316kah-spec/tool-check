<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>器具確認</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:-apple-system}
header{padding:10px 12px;border-bottom:1px solid #333;color:#bbb;font-size:14px}
main{padding:14px;max-width:560px;margin:auto}
.card{border:1px solid #333;border-radius:12px;padding:16px;margin-bottom:14px}
h2{margin:0 0 8px;font-size:20px}
button{width:100%;padding:16px;font-size:18px;border-radius:12px;background:#1a1a1a;color:#fff;border:1px solid #333;margin-top:10px}
.stateOut{border-color:#a33}
.statePending{border-color:#aa3}
.stateIn{border-color:#333}
.small{opacity:.7;font-size:14px}
</style>
</head>
<body>
<header id="hdr"></header>
<main id="app"></main>

<script>
const GAS_URL =
"https://script.google.com/macros/s/AKfycbxVpcXoJFFmO_sqOi76kMrD6hgFBR4CdCD5hpI_4bTLD3VeVrP2qbxDiJ_RTrotzLsx/exec";

const p = new URLSearchParams(location.search);
const site = p.get("site") || "未指定";
const tool = p.get("tool"); // 無ければ確認者

const hdr = document.getElementById("hdr");
const app = document.getElementById("app");

hdr.textContent = tool
  ? `現場：${site}　道具：${tool}`
  : `現場：${site}　確認者`;

function draw(html){
  app.innerHTML = html;
}

function fetchWithTimeout(url, ms){
  return Promise.race([
    fetch(url).then(r=>r.json()),
    new Promise((_,reject)=>setTimeout(()=>reject("timeout"), ms))
  ]);
}

function post(action){
  return fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      site, tool,
      toolName:tool||"",
      action,
      user:"現場端末"
    })
  });
}

function loadStatus(){
  draw(`<div class="card stateIn"><h2>状態取得中…</h2></div>`);

  fetchWithTimeout(
    GAS_URL+"?mode=status&site="+encodeURIComponent(site)+"&t="+Date.now(),
    5000
  ).then(j=>{
    const items = Array.isArray(j.items) ? j.items : [];

    /* ===== 確認者 ===== */
    if(!tool){
      if(items.length===0){
        draw(`<div class="card stateIn"><h2>異常なし</h2></div>`);
        return;
      }
      draw(items.map(x=>`
        <div class="card ${x.status==="OUT"?"stateOut":"statePending"}">
          <h2>${x.toolName||x.tool}</h2>
          <div class="small">${x.status} / ${x.by||""}</div>
        </div>
      `).join(""));
      return;
    }

    /* ===== 作業者 ===== */
    const me = items.find(x=>x.tool===tool);
    if(!me){
      draw(`
        <div class="card stateIn">
          <h2>異常なし</h2>
          <button onclick="doTake()">持ち出し</button>
        </div>
      `);
      return;
    }

    if(me.status==="OUT"){
      draw(`
        <div class="card stateOut">
          <h2>持ち出し中</h2>
          <button onclick="doReturn()">返却</button>
        </div>
      `);
      return;
    }

    if(me.status==="PENDING"){
      draw(`<div class="card statePending"><h2>返却確認待ち</h2></div>`);
      return;
    }

    draw(`<div class="card stateIn"><h2>異常なし</h2></div>`);

  }).catch(()=>{
    draw(`<div class="card stateIn"><h2>取得失敗</h2><div class="small">再読み込みしてください</div></div>`);
  });
}

function doTake(){
  draw(`<div class="card stateIn"><h2>処理中…</h2></div>`);
  post("持ち出し").finally(loadStatus);
}

function doReturn(){
  draw(`<div class="card stateIn"><h2>処理中…</h2></div>`);
  post("返却").finally(loadStatus);
}

loadStatus();
setInterval(loadStatus,15000);
</script>
</body>
</html>
