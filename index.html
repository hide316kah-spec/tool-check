<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>器具員数確認</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:-apple-system}
header{padding:10px 12px;border-bottom:1px solid #333;color:#bbb;font-size:14px}
main{padding:14px;max-width:560px;margin:auto}
.card{border:1px solid #333;border-radius:12px;padding:14px;margin-bottom:12px}
h2{margin:0 0 8px 0;font-size:18px}
button{width:100%;padding:14px;margin-top:10px;font-size:18px;border-radius:12px;background:#1a1a1a;color:#fff;border:1px solid #333}
.small{font-size:14px;padding:10px}
.toast{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:#000;border:1px solid #333;padding:18px 22px;border-radius:12px;z-index:9999}
.hidden{display:none}
.stateOut{border-color:#a33}
.statePending{border-color:#aa3}
.stateIn{border-color:#333}
.histRow{font-size:13px;border-top:1px solid #333;padding:6px 0;opacity:.9}
.histRow:first-child{border-top:none}
.histOp{display:inline-block;width:70px}
</style>
</head>
<body>
<header id="hdr"></header>
<main id="app"></main>

<script>
/* ===== 設定 ===== */
const GAS_URL="https://script.google.com/macros/s/AKfycbzQH_wIyl0sfM_FHx1_qiWq5Q4dGzMkYJ4mNEp9vpqzq0dpxPWSSs8Dgc2HBx1jhp0B/exec";
const TOOL_NAME={T001:"手歯止め",T002:"デジタルゲージ",T003:"検測用具",T004:"誘導棒",D001:"その他（扉1）",D002:"その他（扉2）",D003:"その他（扉3）"};
const MEMBERS=["佐藤","山田","高橋"];

/* ===== URL ===== */
const p=new URLSearchParams(location.search);
const site=(p.get("site")||"").trim() || "A";
const tool=(p.get("tool")||"").trim();
const toolName=TOOL_NAME[tool]||"不明";

/* ===== 共通 ===== */
const app=document.getElementById("app");
const hdr=document.getElementById("hdr");
let historyOpen=false;

function toast(t,ms=1600){
  const d=document.createElement("div");
  d.className="toast"; d.textContent=t;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),ms);
}
function vibrate(ms){ try{navigator.vibrate&&navigator.vibrate(ms);}catch(_){} }
function getUser(){return localStorage.getItem("user")||"";}
function setUser(n){localStorage.setItem("user",n);}

/* ===== 通信 ===== */
async function post(action, photoDataUrl){
  const payload={datetime:new Date().toISOString(),site,tool,toolName,action,user:getUser()};
  if(photoDataUrl) payload.photoDataUrl=photoDataUrl;
  const r=await fetch(GAS_URL,{method:"POST",body:JSON.stringify(payload)});
  if(!r.ok) throw new Error();
  const js=await r.json();
  if(js.result!=="ok") throw new Error();
}
async function getStatus(){
  const r=await fetch(`${GAS_URL}?mode=status&site=${encodeURIComponent(site)}&t=${Date.now()}`);
  const js=await r.json();
  if(js.result!=="ok") throw new Error();
  return js.items||[];
}

/* ===== UI ===== */
function header(){
  hdr.textContent=`現場：${site}　道具：${toolName}　端末：${getUser()||"未設定"}`;
}
function showUserSelect(){
  app.innerHTML=`<div class="card"><h2>この端末の名前</h2>${
    MEMBERS.map(n=>`<button onclick="pick('${n}')">${n}</button>`).join("")
  }</div>`;
}
window.pick=n=>{setUser(n);render();};

function renderHistory(items){
  const rows=items
    .filter(x=>x.tool===tool)
    .map(x=>{
      const t=new Date(x.at).toLocaleString();
      return `<div class="histRow"><span class="histOp">${x.status}</span>${t} / ${x.by||""}</div>`;
    });
  return rows.length?rows.join(""):`<div class="histRow">履歴なし</div>`;
}

function ui(items){
  const me=items.find(x=>x.tool===tool);
  const stateClass=!me?"stateIn":me.status==="OUT"?"stateOut":me.status==="PENDING"?"statePending":"stateIn";
  const statusText=!me?"異常なし":me.status==="OUT"?"持ち出し中":me.status==="PENDING"?"返却確認待ち":"異常なし";

  app.innerHTML=`
    <div class="card ${stateClass}">
      <h2>状態</h2>
      <div style="font-size:20px">${statusText}</div>
      ${me&&me.status==="PENDING"?`<button onclick="confirmOk()">確認</button>`:""}
    </div>

    <div class="card">
      <button onclick="take()">持ち出し</button>
      <button onclick="startReturn()">返却（写真）</button>
    </div>

    <div class="card">
      <button class="small" onclick="toggleHistory()">▼ 履歴一覧</button>
      <div id="hist" class="${historyOpen?"":"hidden"}">
        ${renderHistory(items)}
      </div>
    </div>
  `;
}

window.toggleHistory=()=>{
  historyOpen=!historyOpen;
  document.getElementById("hist").classList.toggle("hidden",!historyOpen);
};

window.take=async()=>{
  try{await post("持ち出し");vibrate(80);refresh();}catch{toast("通信エラー");}
};
window.confirmOk=async()=>{
  try{await post("確認");vibrate(80);refresh();}catch{toast("通信エラー");}
};

/* 返却（簡易：写真は省略例） */
window.startReturn=async()=>{
  try{await post("返却");vibrate([60,60,60]);refresh();}catch{toast("通信エラー");}
};

async function refresh(){
  try{ui(await getStatus());}catch{toast("取得失敗");}
}
function render(){
  header();
  if(!getUser()) return showUserSelect();
  refresh();
}
render();
</script>
</body>
</html>
