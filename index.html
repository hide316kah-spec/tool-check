<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>器具員数確認</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:-apple-system}
header{padding:10px 12px;border-bottom:1px solid #333;color:#bbb;font-size:14px}
main{padding:14px;max-width:560px;margin:auto}
.card{border:1px solid #333;border-radius:12px;padding:14px;margin-bottom:12px}
h2{margin:0 0 8px 0;font-size:18px}
button{width:100%;padding:14px;margin-top:10px;font-size:18px;border-radius:12px;background:#1a1a1a;color:#fff;border:1px solid #333}
.small{font-size:14px;padding:10px}
.list .item{border:1px solid #333;border-radius:12px;padding:12px;margin-top:10px}
.item b{display:block;font-size:16px}
.item .meta{opacity:.7;font-size:13px;margin-top:6px}
.stateOut{border-color:#a33}
.statePending{border-color:#aa3}
.stateIn{border-color:#333}
.hidden{display:none}
video{width:100%;border-radius:12px;border:1px solid #333;background:#000}
</style>
</head>

<body>
<header id="hdr"></header>
<main id="app"></main>

<script>
/* ===== 設定 ===== */
const GAS_URL="https://script.google.com/macros/s/【あなたのexec URL】/exec";

const TOOL_NAME={
  T001:"手歯止め",T002:"デジタルゲージ",T003:"検測用具",
  T004:"誘導棒",D001:"その他（扉1）",D002:"その他（扉2）",D003:"その他（扉3）"
};
const MEMBERS=["佐藤","山田","高橋"];

/* ===== URL ===== */
const p=new URLSearchParams(location.search);
const site=(p.get("site")||"").trim();
const tool=(p.get("tool")||"").trim();
const toolName=TOOL_NAME[tool]||tool;

/* ===== 共通 ===== */
const app=document.getElementById("app");
const hdr=document.getElementById("hdr");

function getUser(){return localStorage.getItem("user")||"";}
function setUser(n){localStorage.setItem("user",n);}

async function post(action, photoDataUrl){
  const payload={
    datetime:new Date().toISOString(),
    site, tool, toolName,
    action, user:getUser()
  };
  if(photoDataUrl) payload.photoDataUrl=photoDataUrl;

  const r=await fetch(GAS_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  if(!r.ok) throw new Error();
  const js=await r.json();
  if(js.result!=="ok") throw new Error();
}

async function getStatus(){
  const r=await fetch(`${GAS_URL}?mode=status&site=${encodeURIComponent(site)}&t=${Date.now()}`);
  if(!r.ok) throw new Error();
  const js=await r.json();
  if(js.result!=="ok") throw new Error();
  return js.items||[];
}

/* ===== カメラ ===== */
let stream=null;

async function capture(){
  const v=document.getElementById("v");
  await new Promise(r=>setTimeout(r,150));
  const c=document.createElement("canvas");
  c.width=v.videoWidth; c.height=v.videoHeight;
  c.getContext("2d").drawImage(v,0,0);
  return c.toDataURL("image/jpeg",0.4); // 超低画質
}

function header(){
  hdr.textContent=`現場：${site}　道具：${toolName}（${tool}）　端末：${getUser()||"未設定"}`;
}

function renderUserSelect(){
  app.innerHTML=`
    <div class="card">
      <h2>端末の使用者</h2>
      ${MEMBERS.map(n=>`<button onclick="pick('${n}')">${n}</button>`).join("")}
    </div>`;
}
window.pick=n=>{setUser(n);render();};

function render(items){
  header();
  if(!getUser()){renderUserSelect();return;}

  const me=items.find(x=>x.tool===tool);
  const state=me?me.status:"";

  /* ===== 状態カード ===== */
  let stateText="持ち出しなし";
  let stateClass="stateIn";
  let stateExtra="";

  if(state==="OUT"){
    stateText=`${toolName} を持ち出し中`;
    stateClass="stateOut";
  }
  if(state==="PENDING"){
    stateText=`${toolName} 返却確認待ち`;
    stateClass="statePending";
    stateExtra=`
      <button class="small" onclick="openPhoto('${me.photoUrl}')">写真を見る</button>
      <button onclick="confirmOk()">確認</button>`;
  }

  /* ===== 履歴一覧 ===== */
  let historyHtml="";
  if(items.length===0){
    historyHtml=`<div class="item"><b>持ち出しなし</b></div>`;
  }else{
    historyHtml=items.map(x=>{
      let lines=[];
      if(x.status==="OUT"){
        lines.push(`持ち出し中 / ${x.by} / ${new Date(x.at).toLocaleString()}`);
      }
      if(x.status==="PENDING"){
        lines.push(`返却済み（確認待ち） / ${x.by} / ${new Date(x.at).toLocaleString()}`);
      }
      return `
        <div class="item">
          <b>${x.toolName}（${x.tool}）</b>
          <div class="meta">${lines.join("<br>")}</div>
        </div>`;
    }).join("");
  }

  app.innerHTML=`
    <div class="card ${stateClass}">
      <h2>状態</h2>
      <div style="font-size:20px">${stateText}</div>
      ${stateExtra}
    </div>

    <div class="card">
      <h2>${toolName}</h2>
      <button onclick="take()">持ち出し</button>
      <button onclick="startReturn()">返却（写真必須）</button>

      <div id="cam" class="card hidden">
        <video id="v" autoplay playsinline></video>
        <button onclick="shotAndSend()">撮影して返却</button>
        <button class="small" onclick="cancelCam()">中止</button>
      </div>
    </div>

    <div class="card">
      <h2>履歴一覧</h2>
      ${historyHtml}
    </div>`;
}

window.openPhoto=u=>window.open(u,"_blank");

window.take=async()=>{
  await post("持ち出し");
  refresh();
};

window.startReturn=async()=>{
  const cam=document.getElementById("cam");
  cam.classList.remove("hidden");
  const v=document.getElementById("v");
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  v.srcObject=stream;
};

window.cancelCam=()=>{
  if(stream) stream.getTracks().forEach(t=>t.stop());
  document.getElementById("cam").classList.add("hidden");
};

window.shotAndSend=async()=>{
  const data=await capture();
  cancelCam();
  await post("返却",data);
  refresh();
};

window.confirmOk=async()=>{
  await post("確認");
  refresh();
};

async function refresh(){
  try{
    const items=await getStatus();
    render(items);
  }catch{
    render([]);
  }
}
refresh();
setInterval(refresh,15000);
</script>
</body>
</html>
