<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>器具員数確認</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:-apple-system}
header{padding:10px 12px;border-bottom:1px solid #333;color:#bbb;font-size:14px}
main{padding:14px;max-width:560px;margin:auto}
.card{border:1px solid #333;border-radius:12px;padding:14px;margin-bottom:12px}
h2{margin:0 0 8px 0;font-size:18px}
button{width:100%;padding:14px;margin-top:10px;font-size:18px;border-radius:12px;background:#1a1a1a;color:#fff;border:1px solid #333}
.small{font-size:14px;padding:10px}
.toast{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:#000;border:1px solid #333;padding:18px 22px;border-radius:12px;z-index:9999}
video{width:100%;border-radius:12px;border:1px solid #333;background:#000}
.hidden{display:none}
.stateOut{border-color:#a33}
.statePending{border-color:#aa3}
.stateIn{border-color:#333}
</style>
</head>
<body>
<header id="hdr"></header>
<main id="app"></main>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbxVpcXoJFFmO_sqOi76kMrD6hgFBR4CdCD5hpI_4bTLD3VeVrP2qbxDiJ_RTrotzLsx/exec";

const TOOL_NAME={T001:"手歯止め"};
const MEMBERS=["佐藤","山田","高橋"];

const p=new URLSearchParams(location.search);
const site=(p.get("site")||"").trim() || "A";
const tool=(p.get("tool")||"").trim();
const toolName=TOOL_NAME[tool]||"不明";

const app=document.getElementById("app");
const hdr=document.getElementById("hdr");

function toast(t){
  const d=document.createElement("div");
  d.className="toast";
  d.textContent=t;
  document.body.appendChild(d);
  setTimeout(()=>d.remove(),2000);
}

function getUser(){return localStorage.getItem("user")||"";}
function setUser(n){localStorage.setItem("user",n);}

async function post(action, photoDataUrl){
  const payload={datetime:new Date().toISOString(),site,tool,toolName,action,user:getUser()};
  if(photoDataUrl) payload.photoDataUrl=photoDataUrl;
  const r=await fetch(GAS_URL,{method:"POST",body:JSON.stringify(payload)});
  if(!r.ok) throw new Error();
  const j=await r.json();
  if(j.result!=="ok") throw new Error();
}

async function getStatus(){
  const r=await fetch(`${GAS_URL}?mode=status&site=${encodeURIComponent(site)}`);
  const j=await r.json();
  if(j.result!=="ok") throw new Error();
  return j.items||[];
}

function showUserSelect(){
  app.innerHTML=MEMBERS.map(n=>`<button onclick="pick('${n}')">${n}</button>`).join("");
}
window.pick=n=>{setUser(n);render();};

function header(){
  hdr.textContent=`現場：${site}　道具：${toolName}（${tool}）　端末：${getUser()}`;
}

function ui(items){
  const me=items.find(x=>x.tool===tool);
  const st=!me?"異常なし":me.status==="OUT"?"持ち出し中":me.status==="PENDING"?"返却確認待ち":"異常なし";

  app.innerHTML=`
    <div class="card ${me?.status==="OUT"?"stateOut":me?.status==="PENDING"?"statePending":"stateIn"}">
      <h2>${st}</h2>
      ${me?.status==="PENDING"?`<button onclick="confirmOk()">確認</button>`:""}
    </div>
    <div class="card">
      <button onclick="take()">持ち出し</button>
    </div>
  `;
}

window.take=async()=>{
  try{
    await post("持ち出し");
    toast("持ち出しOK");
    refresh();
  }catch{
    toast("通信エラー");
  }
};

window.confirmOk=async()=>{
  try{
    await post("確認");
    toast("確認OK");
    refresh();
  }catch{
    toast("通信エラー");
  }
};

/* ★ここが本命修正 */
async function refresh(){
  try{
    const items=await getStatus();
    ui(items);
  }catch(e){
    ui([]);            // ← 必ず描画
    toast("状態取得失敗");
  }
}

function render(){
  header();
  if(!getUser()) return showUserSelect();
  refresh();
}
render();
</script>
</body>
</html>
